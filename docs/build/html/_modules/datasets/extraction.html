<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>datasets.extraction &mdash; open-mimic-iii - documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=b1628c55"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            open-mimic-iii
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_rst/datasets.html">datasets package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_rst/generators.html">generators package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_rst/metrics.html">metrics package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_rst/models.html">models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_rst/pipelines.html">pipelines package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_rst/preprocessing.html">preprocessing package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">open-mimic-iii</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../datasets.html">datasets</a></li>
      <li class="breadcrumb-item active">datasets.extraction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for datasets.extraction</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Dataset Extraction Module</span>
<span class="sd">=========================</span>

<span class="sd">This module provides functions and classes for extracting and processing dataset files.</span>
<span class="sd">It supports both compact and iterative extraction methods to handle different use cases.</span>

<span class="sd">Functions</span>
<span class="sd">---------</span>
<span class="sd">- compact_extraction(storage_path, source_path, num_subjects, num_samples, subject_ids, task)</span>
<span class="sd">    Performs compact extraction of the dataset.</span>
<span class="sd">- iterative_extraction(source_path, storage_path, chunksize, num_subjects, num_samples, subject_ids, task)</span>
<span class="sd">    Performs iterative extraction of the dataset.</span>
<span class="sd">- read_patients_csv(dataset_folder)</span>
<span class="sd">    Reads the PATIENTS.csv file from the specified dataset folder.</span>
<span class="sd">- read_admission_csv(dataset_folder)</span>
<span class="sd">    Reads the ADMISSIONS.csv file from the specified dataset folder.</span>
<span class="sd">- read_icustays_csv(dataset_folder)</span>
<span class="sd">    Reads the ICUSTAYS.csv file from the specified dataset folder.</span>
<span class="sd">- read_icd9codes_csv(dataset_folder)</span>
<span class="sd">    Reads the D_ICD_DIAGNOSES.csv file from the specified dataset folder.</span>
<span class="sd">- read_events_dictionary(dataset_folder)</span>
<span class="sd">    Reads the D_ITEMS.csv file from the specified dataset folder.</span>
<span class="sd">- merge_patient_history(patients_df, admissions_df, icustays_df, min_nb_stays, max_nb_stays)</span>
<span class="sd">    Merges patient, admission, and ICU stay data to create a patient history DataFrame.</span>
<span class="sd">- make_subject_infos(patients_df, admission_info_df, icustays_df, min_nb_stays, max_nb_stays)</span>
<span class="sd">    Creates a DataFrame containing information about subjects by merging patient, admission, and ICU stay data.</span>
<span class="sd">- make_icu_history(patients_df, admissions_df, icustays_df, min_nb_stays, max_nb_stays)</span>
<span class="sd">    Creates a DataFrame describing each ICU stay with admission data, patient data, and mortality.</span>
<span class="sd">- make_diagnoses(dataset_folder, icd9codes_df, icu_history_df)</span>
<span class="sd">    Creates a DataFrame containing descriptions of diagnoses with direct links to subjects and ICU stays.</span>
<span class="sd">- make_phenotypes(diagnoses_df, definition_map)</span>
<span class="sd">    Creates a binary matrix with diagnoses over ICU stays.</span>
<span class="sd">- get_by_subject(df, sort_by)</span>
<span class="sd">    Groups events by subject ID.</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">&gt;&gt;&gt; from extraction_module import compact_extraction, iterative_extraction</span>
<span class="sd">&gt;&gt;&gt; storage_path = Path(&quot;/path/to/storage&quot;)</span>
<span class="sd">&gt;&gt;&gt; source_path = Path(&quot;/path/to/source&quot;)</span>
<span class="sd">&gt;&gt;&gt; dataset_dict = compact_extraction(storage_path, source_path, num_subjects=100)</span>
<span class="sd">&gt;&gt;&gt; reader = iterative_extraction(source_path, storage_path, chunksize=1000)</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">utils.IO</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.extraction_functions</span> <span class="kn">import</span> <span class="n">extract_subject_events</span><span class="p">,</span> <span class="n">extract_timeseries</span>
<span class="kn">from</span> <span class="nn">.event_producer</span> <span class="kn">import</span> <span class="n">EventProducer</span>
<span class="kn">from</span> <span class="nn">.timeseries_processor</span> <span class="kn">import</span> <span class="n">TimeseriesProcessor</span>
<span class="kn">from</span> <span class="nn">..trackers</span> <span class="kn">import</span> <span class="n">ExtractionTracker</span>
<span class="kn">from</span> <span class="nn">..mimic_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..readers</span> <span class="kn">import</span> <span class="n">ExtractedSetReader</span><span class="p">,</span> <span class="n">EventReader</span>
<span class="kn">from</span> <span class="nn">..writers</span> <span class="kn">import</span> <span class="n">DataSetWriter</span>


<div class="viewcode-block" id="compact_extraction">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.compact_extraction">[docs]</a>
<span class="k">def</span> <span class="nf">compact_extraction</span><span class="p">(</span><span class="n">storage_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                       <span class="n">source_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                       <span class="n">num_subjects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">subject_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform single shot extraction of the dataset from the original source. Ensure enough RAM is available.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    storage_path : Path</span>
<span class="sd">        The path to the storage directory where the extracted data will be saved.</span>
<span class="sd">    source_path : Path</span>
<span class="sd">        The path to the source directory containing the raw data files.</span>
<span class="sd">    num_subjects : int, optional</span>
<span class="sd">        The number of subjects to extract. If None, all subjects are extracted. Default is None.</span>
<span class="sd">    num_samples : int, optional</span>
<span class="sd">        The number of samples to extract. If None, all samples are extracted. Default is None.</span>
<span class="sd">    subject_ids : list of int, optional</span>
<span class="sd">        List of subject IDs to extract. If None, all subjects are extracted. Default is None.</span>
<span class="sd">    task : str, optional</span>
<span class="sd">        Specific task to extract data for. If None, all tasks are extracted. Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the extracted data.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; storage_path = Path(&quot;/path/to/storage&quot;)</span>
<span class="sd">    &gt;&gt;&gt; source_path = Path(&quot;/path/to/source&quot;)</span>
<span class="sd">    &gt;&gt;&gt; dataset = compact_extraction(storage_path, source_path, num_subjects=100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_subject_ids</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span>
    <span class="n">resource_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">)</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="n">ExtractionTracker</span><span class="p">(</span><span class="n">storage_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;progress&quot;</span><span class="p">),</span>
                                <span class="n">num_subjects</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">,</span>
                                <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
                                <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">)</span>

    <span class="n">dataset_writer</span> <span class="o">=</span> <span class="n">DataSetWriter</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span>
    <span class="n">dataset_reader</span> <span class="o">=</span> <span class="n">ExtractedSetReader</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">is_finished</span><span class="p">:</span>  <span class="c1"># and not compute_data:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compact data extraction already finalized in directory:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make sure we don&#39;t pick empty subjects for the subsequent processing</span>
            <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;icu_history.csv&quot;</span><span class="p">),</span>
                                                     <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                         <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;icu_history&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>

            <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">get_processable_subjects</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span>

        <span class="k">if</span> <span class="n">num_subjects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_subjects</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">):</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">original_subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">original_subject_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span>
        <span class="c1"># If we know some processing is comming after we return all possible subjects for that task</span>
        <span class="k">return</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_subjects</span><span class="p">(</span><span class="n">read_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">)</span>

    <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Compact Dataset Extraction: ALL&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting compact data extraction.&quot;</span><span class="p">)</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting data from source:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving data at location:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Read Dataframes for ICU history</span>
    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_icu_history</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;ICU history data already extracted&quot;</span><span class="p">)</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;icu_history.csv&quot;</span><span class="p">),</span>
                                                 <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                     <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;icu_history&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
        <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;subject_info.csv&quot;</span><span class="p">),</span>
                                                  <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                      <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;subject_info&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting ICU history data&quot;</span><span class="p">)</span>
        <span class="n">patients_df</span> <span class="o">=</span> <span class="n">read_patients_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="n">admissions_df</span><span class="p">,</span> <span class="n">admissions_info_df</span> <span class="o">=</span> <span class="n">read_admission_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="n">icustays_df</span> <span class="o">=</span> <span class="n">read_icustays_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>

        <span class="c1"># Make ICU history dataframe</span>
        <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">make_subject_infos</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admissions_info_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">)</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">make_icu_history</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admissions_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_icu_history</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">icu_history_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;icu_history.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subject_info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;subject_info.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_diagnoses</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Patient diagnosis data already extracted&quot;</span><span class="p">)</span>
        <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;diagnoses.csv&quot;</span><span class="p">),</span>
                                               <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                   <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;diagnosis&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting patient diagnosis data&quot;</span><span class="p">)</span>
        <span class="c1"># Read Dataframes for diagnoses</span>
        <span class="n">icd9codes_df</span> <span class="o">=</span> <span class="n">read_icd9codes_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">diagnoses_df</span><span class="p">,</span> <span class="n">definition_map</span> <span class="o">=</span> <span class="n">make_diagnoses</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">icd9codes_df</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
        <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;diagnoses.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">tracker</span><span class="o">.</span><span class="n">has_diagnoses</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">subject_ids</span><span class="p">,</span> <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">get_subject_ids</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                                                  <span class="n">num_subjects</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">,</span>
                                                  <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">,</span>
                                                  <span class="n">existing_subjects</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">,</span>
                                                  <span class="n">icu_history_df</span><span class="o">=</span><span class="n">icu_history_df</span><span class="p">)</span>

    <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">reduce_by_subjects</span><span class="p">(</span><span class="n">subject_info_df</span><span class="p">,</span> <span class="n">subject_ids</span><span class="p">)</span>
    <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">reduce_by_subjects</span><span class="p">(</span><span class="n">diagnoses_df</span><span class="p">,</span> <span class="n">subject_ids</span><span class="p">)</span>

    <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting subject ICU history&quot;</span><span class="p">)</span>
    <span class="n">subject_icu_history</span> <span class="o">=</span> <span class="n">get_by_subject</span><span class="p">(</span><span class="n">icu_history_df</span><span class="p">,</span>
                                         <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;ICUHISTORY&quot;</span><span class="p">][</span><span class="s2">&quot;sort_value&quot;</span><span class="p">])</span>

    <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting subject diagnoses&quot;</span><span class="p">)</span>
    <span class="n">subject_diagnoses</span> <span class="o">=</span> <span class="n">get_by_subject</span><span class="p">(</span><span class="n">diagnoses_df</span><span class="p">[</span><span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;DIAGNOSES&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]],</span>
                                       <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;DIAGNOSES&quot;</span><span class="p">][</span><span class="s2">&quot;sort_value&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_bysubject_info</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Subject diagnoses and subject ICU history already stored&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataset_writer</span><span class="o">.</span><span class="n">write_bysubject</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;subject_icu_history&quot;</span><span class="p">:</span> <span class="n">subject_icu_history</span><span class="p">,</span>
                <span class="s2">&quot;subject_diagnoses&quot;</span><span class="p">:</span> <span class="n">subject_diagnoses</span>
            <span class="p">},</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_subject_events</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Subject events already extracted&quot;</span><span class="p">)</span>
        <span class="n">subject_events</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_events</span><span class="p">(</span><span class="n">read_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting subject events&quot;</span><span class="p">)</span>
        <span class="c1"># Read Dataframes for event table</span>
        <span class="n">event_reader</span> <span class="o">=</span> <span class="n">EventReader</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="n">chartevents_df</span> <span class="o">=</span> <span class="n">event_reader</span><span class="o">.</span><span class="n">get_all</span><span class="p">()</span>

        <span class="c1"># Make subject event table</span>
        <span class="n">subject_events</span> <span class="o">=</span> <span class="n">extract_subject_events</span><span class="p">(</span><span class="n">chartevents_df</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
        <span class="n">dataset_writer</span><span class="o">.</span><span class="n">write_bysubject</span><span class="p">({</span>
            <span class="s2">&quot;subject_events&quot;</span><span class="p">:</span> <span class="n">subject_events</span><span class="p">,</span>
        <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_subject_events</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_timeseries</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_episodic_data</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting subject timeseries and episodic data&quot;</span><span class="p">)</span>
        <span class="c1"># Read Dataframes for time series</span>
        <span class="n">varmap_df</span> <span class="o">=</span> <span class="n">read_varmap_csv</span><span class="p">(</span><span class="n">resource_folder</span><span class="p">)</span>
        <span class="n">episodic_data</span><span class="p">,</span> <span class="n">timeseries</span> <span class="o">=</span> <span class="n">extract_timeseries</span><span class="p">(</span><span class="n">subject_events</span><span class="p">,</span> <span class="n">subject_diagnoses</span><span class="p">,</span>
                                                    <span class="n">subject_icu_history</span><span class="p">,</span> <span class="n">varmap_df</span><span class="p">)</span>
        <span class="n">name_data_pair</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;episodic_data&quot;</span><span class="p">:</span> <span class="n">episodic_data</span><span class="p">,</span> <span class="s2">&quot;timeseries&quot;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">}</span>
        <span class="n">dataset_writer</span><span class="o">.</span><span class="n">write_bysubject</span><span class="p">(</span><span class="n">name_data_pair</span><span class="p">,</span> <span class="n">exists_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_episodic_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Subject timeseries and episodic data already extracted&quot;</span><span class="p">)</span>

    <span class="n">tracker</span><span class="o">.</span><span class="n">is_finished</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finalized data extraction in directory:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">original_subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">original_subject_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">original_subject_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_subjects</span><span class="p">(</span><span class="n">read_ids</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subject_ids</span><span class="o">=</span><span class="n">original_subject_ids</span><span class="p">)</span></div>



<div class="viewcode-block" id="iterative_extraction">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.iterative_extraction">[docs]</a>
<span class="k">def</span> <span class="nf">iterative_extraction</span><span class="p">(</span><span class="n">source_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                         <span class="n">storage_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">num_subjects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">num_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">subject_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExtractedSetReader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform iterative extraction of the dataset, with specified chunk size. This will require less RAM and run on multiple processes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_path : Path</span>
<span class="sd">        The path to the source directory containing the raw data files.</span>
<span class="sd">    storage_path : Path, optional</span>
<span class="sd">        The path to the storage directory where the extracted data will be saved. Default is None.</span>
<span class="sd">    chunksize : int, optional</span>
<span class="sd">        The size of chunks to read at a time. Default is None.</span>
<span class="sd">    num_subjects : int, optional</span>
<span class="sd">        The number of subjects to extract. If None, all subjects are extracted. Default is None.</span>
<span class="sd">    num_samples : int, optional</span>
<span class="sd">        The number of samples to extract. If None, all samples are extracted. Default is None.</span>
<span class="sd">    subject_ids : list of int, optional</span>
<span class="sd">        List of subject IDs to extract. If None, all subjects are extracted. Default is None.</span>
<span class="sd">    task : str, optional</span>
<span class="sd">        Specific task to extract data for. If None, all tasks are extracted. Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ExtractedSetReader</span>
<span class="sd">        The extracted set reader to access the dataset.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; source_path = Path(&quot;/path/to/source&quot;)</span>
<span class="sd">    &gt;&gt;&gt; storage_path = Path(&quot;/path/to/storage&quot;)</span>
<span class="sd">    &gt;&gt;&gt; reader = iterative_extraction(source_path, storage_path, chunksize=1000, num_subjects=100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Not sure</span>
    <span class="n">original_subject_ids</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span>
    <span class="n">resource_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">)</span>

    <span class="n">tracker</span> <span class="o">=</span> <span class="n">ExtractionTracker</span><span class="p">(</span><span class="n">storage_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;progress&quot;</span><span class="p">),</span>
                                <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
                                <span class="n">num_subjects</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">,</span>
                                <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">)</span>

    <span class="n">dataset_writer</span> <span class="o">=</span> <span class="n">DataSetWriter</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span>
    <span class="n">dataset_reader</span> <span class="o">=</span> <span class="n">ExtractedSetReader</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">is_finished</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iterative data extraction already finalized in directory:</span><span class="se">\n</span><span class="si">{</span><span class="n">storage_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make sure we don&#39;t pick empty subjects for the subsequent processing</span>
            <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;icu_history.csv&quot;</span><span class="p">),</span>
                                                     <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                         <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;icu_history&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>

            <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">get_processable_subjects</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span>

        <span class="k">if</span> <span class="n">num_subjects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_subjects</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">):</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">original_subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subject_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">original_subject_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span>
        <span class="c1"># If we know some processing is comming after we return all possible subjects for that task</span>
        <span class="k">return</span> <span class="n">ExtractedSetReader</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">)</span>

    <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Iterative Dataset Extraction: ALL&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting iterative data extraction.&quot;</span><span class="p">)</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting data from source:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving data at location:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">storage_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Make ICU history dataframe</span>
    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_icu_history</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;ICU history data already extracted&quot;</span><span class="p">)</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;icu_history.csv&quot;</span><span class="p">),</span>
                                                 <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                     <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;icu_history&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
        <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;subject_info.csv&quot;</span><span class="p">),</span>
                                                  <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                      <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;subject_info&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Read Dataframes for ICU history</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting ICU history data&quot;</span><span class="p">)</span>
        <span class="n">patients_df</span> <span class="o">=</span> <span class="n">read_patients_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>

        <span class="n">admissions_df</span><span class="p">,</span> <span class="n">admission_info_df</span> <span class="o">=</span> <span class="n">read_admission_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="n">icustays_df</span> <span class="o">=</span> <span class="n">read_icustays_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="c1"># Generate history</span>
        <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">make_subject_infos</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admission_info_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">)</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">make_icu_history</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admissions_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">)</span>

        <span class="c1"># TODO! encapsualte in function</span>
        <span class="n">icu_history_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;icu_history.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">subject_info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;subject_info.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_icu_history</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Read Dataframes for diagnoses</span>

    <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_diagnoses</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Patient diagnosis data already extracted&quot;</span><span class="p">)</span>
        <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;diagnoses.csv&quot;</span><span class="p">),</span>
                                               <span class="n">dtypes</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span>
                                                   <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;diagnosis&quot;</span><span class="p">][</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting Patient diagnosis data&quot;</span><span class="p">)</span>

        <span class="n">icd9codes_df</span> <span class="o">=</span> <span class="n">read_icd9codes_csv</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
        <span class="n">diagnoses_df</span><span class="p">,</span> <span class="n">definition_map</span> <span class="o">=</span> <span class="n">make_diagnoses</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">icd9codes_df</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
        <span class="c1"># TODO! not working</span>
        <span class="c1"># make_phenotypes(diagnoses_df,</span>
        <span class="c1">#                definition_map).to_csv(Path(storage_path, &quot;phenotype_matrix.csv&quot;))</span>
        <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="s2">&quot;diagnoses.csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_diagnoses</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">subject_ids</span><span class="p">,</span> <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">get_subject_ids</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
                                                  <span class="n">num_subjects</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">,</span>
                                                  <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">,</span>
                                                  <span class="n">existing_subjects</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">,</span>
                                                  <span class="n">icu_history_df</span><span class="o">=</span><span class="n">icu_history_df</span><span class="p">)</span>

    <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">reduce_by_subjects</span><span class="p">(</span><span class="n">diagnoses_df</span><span class="p">,</span> <span class="n">subject_ids</span><span class="p">)</span>
    <span class="n">subject_diagnoses</span> <span class="o">=</span> <span class="n">get_by_subject</span><span class="p">(</span><span class="n">diagnoses_df</span><span class="p">[</span><span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;DIAGNOSES&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]],</span>
                                       <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;DIAGNOSES&quot;</span><span class="p">][</span><span class="s2">&quot;sort_value&quot;</span><span class="p">])</span>
    <span class="n">subject_icu_history</span> <span class="o">=</span> <span class="n">get_by_subject</span><span class="p">(</span><span class="n">icu_history_df</span><span class="p">,</span>
                                         <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;ICUHISTORY&quot;</span><span class="p">][</span><span class="s2">&quot;sort_value&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_subject_events</span><span class="p">:</span>
        <span class="n">name_data_pairs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;subject_diagnoses&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">subject_id</span><span class="p">:</span> <span class="n">frame_df</span> <span class="k">for</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">frame_df</span> <span class="ow">in</span> <span class="n">subject_diagnoses</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="s2">&quot;subject_icu_history&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">subject_id</span><span class="p">:</span> <span class="n">frame_df</span> <span class="k">for</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">frame_df</span> <span class="ow">in</span> <span class="n">subject_icu_history</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">dataset_writer</span><span class="o">.</span><span class="n">write_bysubject</span><span class="p">(</span><span class="n">name_data_pairs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Subject diagnoses and subject ICU history already stored&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_subject_events</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extracting subject events&quot;</span><span class="p">)</span>

        <span class="n">EventProducer</span><span class="p">(</span><span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">,</span>
                      <span class="n">storage_path</span><span class="o">=</span><span class="n">storage_path</span><span class="p">,</span>
                      <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
                      <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span>
                      <span class="n">tracker</span><span class="o">=</span><span class="n">tracker</span><span class="p">,</span>
                      <span class="n">icu_history_df</span><span class="o">=</span><span class="n">icu_history_df</span><span class="p">,</span>
                      <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Subject events already extracted&quot;</span><span class="p">)</span>

    <span class="n">varmap_df</span> <span class="o">=</span> <span class="n">read_varmap_csv</span><span class="p">(</span><span class="n">resource_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_episodic_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tracker</span><span class="o">.</span><span class="n">has_timeseries</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="s2">&quot;Extraction timeseries data from subject events&quot;</span><span class="p">)</span>

        <span class="c1"># Starting the processor pool</span>
        <span class="n">pool_processor</span> <span class="o">=</span> <span class="n">TimeseriesProcessor</span><span class="p">(</span><span class="n">storage_path</span><span class="o">=</span><span class="n">storage_path</span><span class="p">,</span>
                                             <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">,</span>
                                             <span class="n">tracker</span><span class="o">=</span><span class="n">tracker</span><span class="p">,</span>
                                             <span class="n">subject_ids</span><span class="o">=</span><span class="n">subject_ids</span><span class="p">,</span>
                                             <span class="n">diagnoses_df</span><span class="o">=</span><span class="n">subject_diagnoses</span><span class="p">,</span>
                                             <span class="n">icu_history_df</span><span class="o">=</span><span class="n">subject_icu_history</span><span class="p">,</span>
                                             <span class="n">varmap_df</span><span class="o">=</span><span class="n">varmap_df</span><span class="p">,</span>
                                             <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">)</span>

        <span class="n">pool_processor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject directories extracted: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">tracker</span><span class="o">.</span><span class="n">has_episodic_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">has_timeseries</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeseries data already created&quot;</span><span class="p">)</span>

    <span class="n">tracker</span><span class="o">.</span><span class="n">is_finished</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">original_subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">original_subject_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">original_subject_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">subject_ids</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ExtractedSetReader</span><span class="p">(</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">subject_ids</span><span class="o">=</span><span class="n">original_subject_ids</span><span class="p">)</span></div>



<div class="viewcode-block" id="reduce_by_subjects">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.reduce_by_subjects">[docs]</a>
<span class="k">def</span> <span class="nf">reduce_by_subjects</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">subject_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce the dataframe to only include the specified subject IDs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataframe : pd.DataFrame</span>
<span class="sd">        The dataframe to reduce.</span>
<span class="sd">    subject_ids : list</span>
<span class="sd">        The list of subject IDs to retain in the dataframe.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        The reduced dataframe containing only the specified subject IDs.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({&quot;SUBJECT_ID&quot;: [10006, 10011, 10019], &quot;value&quot;: [10, 20, 30]})</span>
<span class="sd">    &gt;&gt;&gt; reduce_by_subjects(df, [10006, 10019])</span>
<span class="sd">       SUBJECT_ID  value</span>
<span class="sd">    0           10006     10</span>
<span class="sd">    2           10019     30</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;SUBJECT_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">dataframe</span></div>



<div class="viewcode-block" id="get_subject_ids">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.get_subject_ids">[docs]</a>
<span class="k">def</span> <span class="nf">get_subject_ids</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">icu_history_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                    <span class="n">subject_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">num_subjects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">existing_subjects</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the subject IDs that can be processed for the given task. Many subjects will need to be</span>
<span class="sd">    discarded as they do not fulfill the minimum length of stay requirement of 48H for IHM, 4H for DECOMP and LOS.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task : str</span>
<span class="sd">        The task for which to get the subject IDs.</span>
<span class="sd">    icu_history_df : pd.DataFrame</span>
<span class="sd">        The dataframe containing ICU history information.</span>
<span class="sd">    subject_ids : list of int, optional</span>
<span class="sd">        List of subject IDs to extract. If None, all subjects are extracted. Default is None.</span>
<span class="sd">    num_subjects : int, optional</span>
<span class="sd">        The number of subjects to extract. If None, all subjects are extracted. Default is None.</span>
<span class="sd">    existing_subjects : list of int, optional</span>
<span class="sd">        List of existing subjects to exclude from extraction. Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing the list of subject IDs and the reduced ICU history dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">existing_subjects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">existing_subjects</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">subject_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_subjects</span> <span class="o">=</span> <span class="n">get_processable_subjects</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
        <span class="c1"># Notify unknowns</span>
        <span class="n">unknown_subjects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">icu_history_df</span><span class="p">[</span><span class="s2">&quot;SUBJECT_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">unknown_subjects</span><span class="p">:</span>
            <span class="n">warn_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown subjects passed as parameter: </span><span class="si">{</span><span class="o">*</span><span class="n">unknown_subjects</span><span class="p">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Notify unprocessable</span>
        <span class="n">unprocessable_subjects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_subjects</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unprocessable_subjects</span><span class="p">:</span>
            <span class="n">warn_io</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unprocessable subjects passed as parameter: </span><span class="si">{</span><span class="o">*</span><span class="n">unprocessable_subjects</span><span class="p">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Remove already processed</span>
        <span class="n">subject_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="nb">set</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_subjects</span><span class="p">))</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_subjects</span><span class="p">))</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">reduce_by_subjects</span><span class="p">(</span><span class="n">icu_history_df</span><span class="p">,</span> <span class="n">subject_ids</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">num_subjects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_subjects</span> <span class="o">=</span> <span class="n">get_processable_subjects</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">)</span>
        <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">get_subjects_by_number</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">num_subjects</span><span class="p">,</span> <span class="n">existing_subjects</span><span class="p">,</span> <span class="n">all_subjects</span><span class="p">)</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">reduce_by_subjects</span><span class="p">(</span><span class="n">icu_history_df</span><span class="p">,</span> <span class="n">subject_ids</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subject_ids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">subject_ids</span><span class="p">,</span> <span class="n">icu_history_df</span></div>



<div class="viewcode-block" id="get_subjects_by_number">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.get_subjects_by_number">[docs]</a>
<span class="k">def</span> <span class="nf">get_subjects_by_number</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_subjects</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">existing_subjects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                           <span class="n">all_subjects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a specified number of subject IDs, excluding the existing subjects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determined how many are missing</span>
    <span class="n">num_subjects</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_subjects</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_subjects</span><span class="p">))</span>
    <span class="c1"># Chose from uprocessed subjects</span>
    <span class="k">if</span> <span class="n">num_subjects</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_subjects</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">warn_io</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of subjects requested exceeds available subjects: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_subjects</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">remaining_subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_subjects</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_subjects</span><span class="p">))</span>
    <span class="c1"># if tracker is None we grab all possible subjects for return to the next processing step</span>
    <span class="n">subject_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">remaining_subjects</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">num_subjects</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_ids</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_subjects</span>
    <span class="k">return</span> <span class="n">subject_ids</span></div>



<div class="viewcode-block" id="get_processable_subjects">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.get_processable_subjects">[docs]</a>
<span class="k">def</span> <span class="nf">get_processable_subjects</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the subject IDs that can be processed for a given task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;label_start_time&quot;</span> <span class="ow">in</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="n">task</span><span class="p">]:</span>
        <span class="c1"># Some ids will be removed during the preprocessing step</span>
        <span class="c1"># We remove them here to avoid errors</span>
        <span class="n">min_los</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s2">&quot;label_start_time&quot;</span><span class="p">]</span> <span class="o">+</span> \
            <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="n">task</span><span class="p">][</span><span class="s2">&quot;sample_precision&quot;</span><span class="p">]</span>
        <span class="n">min_los</span> <span class="o">/=</span> <span class="mi">24</span>
        <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">icu_history_df</span><span class="p">[</span><span class="n">icu_history_df</span><span class="p">[</span><span class="s2">&quot;LOS&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_los</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">icu_history_df</span><span class="p">[((</span><span class="n">icu_history_df</span><span class="p">[</span><span class="s2">&quot;DISCHTIME&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">icu_history_df</span><span class="p">[</span><span class="s2">&quot;ADMITTIME&quot;</span><span class="p">])</span>
                               <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">min_los</span><span class="p">))][</span><span class="s2">&quot;SUBJECT_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">icu_history_df</span><span class="p">[</span><span class="s2">&quot;SUBJECT_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span></div>



<div class="viewcode-block" id="create_split_info_csv">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.create_split_info_csv">[docs]</a>
<span class="k">def</span> <span class="nf">create_split_info_csv</span><span class="p">(</span><span class="n">episodic_info_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">subject_info_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the information used by the dataset split function to split the subjects into demographics groups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">episodic_info_df</span><span class="p">[</span><span class="s2">&quot;SUBJECT_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">episodic_info_df</span><span class="p">[</span><span class="s2">&quot;SUBJECT_ID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">episodic_info_df</span> <span class="o">=</span> <span class="n">episodic_info_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">subject_info_df</span><span class="p">,</span>
                                              <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                              <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;ICUSTAY_ID&#39;</span><span class="p">],</span>
                                              <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;ICUSTAY_ID&#39;</span><span class="p">])</span>
    <span class="n">episodic_info_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;split_info.csv&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>



<div class="viewcode-block" id="read_patients_csv">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.read_patients_csv">[docs]</a>
<span class="k">def</span> <span class="nf">read_patients_csv</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the PATIENTS.csv file from the specified dataset folder with correct dtypes and columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_folder : Path</span>
<span class="sd">        Path to the dataset folder. Defaults to &#39;data/mimic-iii-demo/&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame containing patient data including birth, death, gender, and ethnicity.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Column names are converted to uppercase.</span>
<span class="sd">    - Columns specified in the configuration are selected.</span>
<span class="sd">    - Date columns are converted to datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">patients_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s2">&quot;PATIENTS.csv&quot;</span><span class="p">),</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>

    <span class="n">patients_df</span> <span class="o">=</span> <span class="n">upper_case_column_names</span><span class="p">(</span><span class="n">patients_df</span><span class="p">)</span>
    <span class="n">patients_df</span> <span class="o">=</span> <span class="n">patients_df</span><span class="p">[</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;convert_datetime&quot;</span><span class="p">]:</span>
        <span class="n">patients_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">patients_df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">patients_df</span></div>



<div class="viewcode-block" id="read_admission_csv">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.read_admission_csv">[docs]</a>
<span class="k">def</span> <span class="nf">read_admission_csv</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the ADMISSIONS.csv file from the specified dataset folder with correct dtypes and columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_folder : Path</span>
<span class="sd">        Path to the dataset folder. Defaults to &#39;data/mimic-iii-demo/&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of pd.DataFrame</span>
<span class="sd">        A tuple containing:</span>
<span class="sd">            - admissions_df: DataFrame with hospital admissions data including admission, discharge, type, and location.</span>
<span class="sd">            - admissions_info_df: DataFrame with additional admission information.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Column names are converted to uppercase.</span>
<span class="sd">    - Columns specified in the configuration are selected.</span>
<span class="sd">    - Date columns are converted to datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;ADMISSIONS&quot;</span><span class="p">]</span>

    <span class="n">admissions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s2">&quot;ADMISSIONS.csv&quot;</span><span class="p">),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="n">admissions_df</span> <span class="o">=</span> <span class="n">upper_case_column_names</span><span class="p">(</span><span class="n">admissions_df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;convert_datetime&quot;</span><span class="p">]:</span>
        <span class="n">admissions_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">admissions_df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

    <span class="n">admissions_info_df</span> <span class="o">=</span> <span class="n">admissions_df</span><span class="p">[</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;info_columns&quot;</span><span class="p">]]</span>
    <span class="n">admissions_df</span> <span class="o">=</span> <span class="n">admissions_df</span><span class="p">[</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">admissions_df</span><span class="p">,</span> <span class="n">admissions_info_df</span></div>



<div class="viewcode-block" id="read_icustays_csv">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.read_icustays_csv">[docs]</a>
<span class="k">def</span> <span class="nf">read_icustays_csv</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the ICUSTAYS.csv file from the specified dataset folder with correct dtypes and columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_folder : Path</span>
<span class="sd">        Path to the dataset folder. Defaults to &#39;data/mimic-iii-demo/&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame with ICU admission data including first &amp; last care unit, ward ID, etc.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Column names are converted to uppercase.</span>
<span class="sd">    - Columns specified in the configuration are selected.</span>
<span class="sd">    - Date columns are converted to datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;ICUSTAYS&quot;</span><span class="p">]</span>

    <span class="n">icustays_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s2">&quot;ICUSTAYS.csv&quot;</span><span class="p">),</span>
                              <span class="n">dtype</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="n">icustays_df</span> <span class="o">=</span> <span class="n">upper_case_column_names</span><span class="p">(</span><span class="n">icustays_df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;convert_datetime&quot;</span><span class="p">]:</span>
        <span class="n">icustays_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">icustays_df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">icustays_df</span></div>



<div class="viewcode-block" id="read_icd9codes_csv">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.read_icd9codes_csv">[docs]</a>
<span class="k">def</span> <span class="nf">read_icd9codes_csv</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the D_ICD_DIAGNOSES.csv file from the specified dataset folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_folder : Path</span>
<span class="sd">        Path to the dataset folder. Defaults to &#39;data/mimic-iii-demo/&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame with dictionaries describing the ICD9 codes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Column names are converted to uppercase.</span>
<span class="sd">    - Columns specified in the configuration are selected.</span>
<span class="sd">    -  International Classification of Diseases, Ninth Revision, are alphanumeric codes used by healthcare providers to classify and code all diagnoses, symptoms, and procedures recorded in conjunction with hospital care in the United States</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;ICD9CODES&quot;</span><span class="p">]</span>

    <span class="n">icd9codes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s1">&#39;D_ICD_DIAGNOSES.csv&#39;</span><span class="p">),</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="n">icd9codes_df</span> <span class="o">=</span> <span class="n">upper_case_column_names</span><span class="p">(</span><span class="n">icd9codes_df</span><span class="p">)</span>
    <span class="n">icd9codes_df</span> <span class="o">=</span> <span class="n">icd9codes_df</span><span class="p">[</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">icd9codes_df</span></div>



<div class="viewcode-block" id="read_events_dictionary">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.read_events_dictionary">[docs]</a>
<span class="k">def</span> <span class="nf">read_events_dictionary</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the D_ITEMS.csv file from the specified dataset folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_folder : Path</span>
<span class="sd">        Path to the dataset folder. Defaults to &#39;data/mimic-iii-demo/&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame containing the items dictionary with ITEMID and DBSOURCE columns.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Column names are converted to uppercase.</span>
<span class="sd">    - Only the ITEMID and DBSOURCE columns are selected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;D_ITEMS&quot;</span><span class="p">]</span>
    <span class="n">dictionary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s2">&quot;D_ITEMS.csv&quot;</span><span class="p">),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="n">dictionary_df</span> <span class="o">=</span> <span class="n">upper_case_column_names</span><span class="p">(</span><span class="n">dictionary_df</span><span class="p">)</span>
    <span class="n">dictionary_df</span> <span class="o">=</span> <span class="n">dictionary_df</span><span class="p">[[</span><span class="s2">&quot;ITEMID&quot;</span><span class="p">,</span> <span class="s2">&quot;DBSOURCE&quot;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">dictionary_df</span></div>



<div class="viewcode-block" id="merge_patient_history">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.merge_patient_history">[docs]</a>
<span class="k">def</span> <span class="nf">merge_patient_history</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admissions_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">,</span> <span class="n">min_nb_stays</span><span class="p">,</span>
                          <span class="n">max_nb_stays</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges patient, admission, and ICU stay data to create a patient history DataFrame of ICU stays, like admission time and mortality.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    patients_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing patient data.</span>
<span class="sd">    admissions_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing admission data.</span>
<span class="sd">    icustays_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing ICU stay data.</span>
<span class="sd">    min_nb_stays : int</span>
<span class="sd">        Minimum number of ICU stays to include a patient.</span>
<span class="sd">    max_nb_stays : int</span>
<span class="sd">        Maximum number of ICU stays to include a patient.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Merged DataFrame with patient history.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Only ICU stays where the first and last care unit and ward ID match are included.</span>
<span class="sd">    - Filters patients based on the number of ICU stays between min_nb_stays and max_nb_stays.</span>
<span class="sd">    - Calculates patient age and filters out children (age &lt; 18).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">icustays_df</span> <span class="o">=</span> <span class="n">icustays_df</span><span class="p">[</span><span class="n">icustays_df</span><span class="p">[</span><span class="s2">&quot;FIRST_CAREUNIT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">icustays_df</span><span class="p">[</span><span class="s2">&quot;LAST_CAREUNIT&quot;</span><span class="p">]]</span>
    <span class="n">icustays_df</span> <span class="o">=</span> <span class="n">icustays_df</span><span class="p">[</span><span class="n">icustays_df</span><span class="p">[</span><span class="s2">&quot;FIRST_WARDID&quot;</span><span class="p">]</span> <span class="o">==</span> \
                                    <span class="n">icustays_df</span><span class="p">[</span><span class="s2">&quot;LAST_WARDID&quot;</span><span class="p">]]</span>

    <span class="n">patient_history_df</span> <span class="o">=</span> <span class="n">icustays_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">admissions_df</span><span class="p">,</span>
                                           <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                           <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">],</span>
                                           <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">])</span>
    <span class="n">patient_history_df</span> <span class="o">=</span> <span class="n">patient_history_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                                  <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">],</span>
                                                  <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">])</span>

    <span class="nb">filter</span> <span class="o">=</span> <span class="n">patient_history_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;HADM_ID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()[[</span><span class="s1">&#39;ICUSTAY_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">filter</span><span class="o">.</span><span class="n">ICUSTAY_ID</span> <span class="o">&gt;=</span> <span class="n">min_nb_stays</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="nb">filter</span><span class="o">.</span><span class="n">ICUSTAY_ID</span> <span class="o">&lt;=</span> <span class="n">max_nb_stays</span><span class="p">)][[</span><span class="s1">&#39;HADM_ID&#39;</span><span class="p">]]</span>
    <span class="n">patient_history_df</span> <span class="o">=</span> <span class="n">patient_history_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span>
                                                  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                                  <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;HADM_ID&#39;</span><span class="p">,</span>
                                                  <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;HADM_ID&#39;</span><span class="p">)</span>

    <span class="n">patient_history_df</span><span class="p">[</span><span class="s1">&#39;AGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">patient_history_df</span><span class="o">.</span><span class="n">INTIME</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">patient_history_df</span><span class="o">.</span><span class="n">DOB</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="n">patient_history_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">patient_history_df</span><span class="o">.</span><span class="n">AGE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;AGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span>
    <span class="c1"># Filter out children</span>
    <span class="c1"># patient_history_df = patient_history_df[patient_history_df.AGE &gt; 18]</span>

    <span class="k">return</span> <span class="n">patient_history_df</span></div>



<div class="viewcode-block" id="make_subject_infos">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.make_subject_infos">[docs]</a>
<span class="k">def</span> <span class="nf">make_subject_infos</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span>
                       <span class="n">admission_info_df</span><span class="p">,</span>
                       <span class="n">icustays_df</span><span class="p">,</span>
                       <span class="n">min_nb_stays</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">max_nb_stays</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a DataFrame containing information about subjects by merging patient, admission, and ICU stay data, like gender and insurance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    patients_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing patient data.</span>
<span class="sd">    admission_info_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing additional admission information.</span>
<span class="sd">    icustays_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing ICU stay data.</span>
<span class="sd">    min_nb_stays : int, optional</span>
<span class="sd">        Minimum number of ICU stays to include a patient, by default 1.</span>
<span class="sd">    max_nb_stays : int, optional</span>
<span class="sd">        Maximum number of ICU stays to include a patient, by default 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame containing subject information with specified columns.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Merges patient history data.</span>
<span class="sd">    - Selects and renames columns according to the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;subject_info&quot;</span><span class="p">]</span>
    <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">merge_patient_history</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admission_info_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">,</span>
                                            <span class="n">min_nb_stays</span><span class="p">,</span> <span class="n">max_nb_stays</span><span class="p">)</span>
    <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">subject_info_df</span><span class="p">[</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]]</span>
    <span class="n">subject_info_df</span> <span class="o">=</span> <span class="n">subject_info_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;FIRST_WARDID&quot;</span><span class="p">:</span> <span class="s2">&quot;WARDID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FIRST_CAREUNIT&quot;</span><span class="p">:</span> <span class="s2">&quot;CAREUNIT&quot;</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">subject_info_df</span></div>



<div class="viewcode-block" id="make_icu_history">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.make_icu_history">[docs]</a>
<span class="k">def</span> <span class="nf">make_icu_history</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span>
                     <span class="n">admissions_df</span><span class="p">,</span>
                     <span class="n">icustays_df</span><span class="p">,</span>
                     <span class="n">min_nb_stays</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">max_nb_stays</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a DataFrame describing each ICU stay with admission data, patient data, and mortality.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    patients_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing patient data.</span>
<span class="sd">    admissions_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing hospital admissions data.</span>
<span class="sd">    icustays_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing ICU stay data.</span>
<span class="sd">    min_nb_stays : int, optional</span>
<span class="sd">        Minimum number of ICU stays to include a patient, by default 1.</span>
<span class="sd">    max_nb_stays : int, optional</span>
<span class="sd">        Maximum number of ICU stays to include a patient, by default 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame describing each ICU stay with admission data, patient data, and mortality.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;icu_history&quot;</span><span class="p">]</span>
    <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">merge_patient_history</span><span class="p">(</span><span class="n">patients_df</span><span class="p">,</span> <span class="n">admissions_df</span><span class="p">,</span> <span class="n">icustays_df</span><span class="p">,</span> <span class="n">min_nb_stays</span><span class="p">,</span>
                                           <span class="n">max_nb_stays</span><span class="p">)</span>

    <span class="c1"># Inunit mortality</span>
    <span class="n">mortality</span> <span class="o">=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DOD</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">INTIME</span> <span class="o">&lt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DOD</span><span class="p">)</span> <span class="o">&amp;</span>
                                                <span class="p">(</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">OUTTIME</span> <span class="o">&gt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DOD</span><span class="p">))</span>

    <span class="n">mortality</span> <span class="o">=</span> <span class="n">mortality</span> <span class="o">|</span> <span class="p">(</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">DEATHTIME</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>
                             <span class="p">((</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">INTIME</span> <span class="o">&lt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DEATHTIME</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">OUTTIME</span> <span class="o">&gt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DEATHTIME</span><span class="p">)))</span>
    <span class="n">icu_history_df</span><span class="p">[</span><span class="s1">&#39;MORTALITY_INUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mortality</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Inhospital mortality</span>
    <span class="n">mortality</span> <span class="o">=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DOD</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">ADMITTIME</span> <span class="o">&lt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DOD</span><span class="p">)</span> <span class="o">&amp;</span>
                                                <span class="p">(</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">DISCHTIME</span> <span class="o">&gt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DOD</span><span class="p">))</span>
    <span class="n">mortality</span> <span class="o">=</span> <span class="n">mortality</span> <span class="o">|</span> <span class="p">(</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">DEATHTIME</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>
                             <span class="p">((</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">ADMITTIME</span> <span class="o">&lt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DEATHTIME</span><span class="p">)</span> <span class="o">&amp;</span>
                              <span class="p">(</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">DISCHTIME</span> <span class="o">&gt;=</span> <span class="n">icu_history_df</span><span class="o">.</span><span class="n">DEATHTIME</span><span class="p">)))</span>
    <span class="n">icu_history_df</span><span class="p">[</span><span class="s1">&#39;MORTALITY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mortality</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">icu_history_df</span><span class="p">[</span><span class="s1">&#39;MORTALITY_INHOSPITAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mortality</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">icu_history_df</span><span class="p">[</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]]</span>
    <span class="n">icu_history_df</span> <span class="o">=</span> <span class="n">icu_history_df</span><span class="p">[</span><span class="n">icu_history_df</span><span class="o">.</span><span class="n">AGE</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">icu_history_df</span></div>



<div class="viewcode-block" id="make_diagnoses">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.make_diagnoses">[docs]</a>
<span class="k">def</span> <span class="nf">make_diagnoses</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="n">icd9codes_df</span><span class="p">,</span> <span class="n">icu_history_df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a DataFrame containing descriptions of diagnoses with direct links to subjects and ICU stays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset_folder : str</span>
<span class="sd">        Path to the dataset folder. Defaults to &#39;data/mimic-iii-demo/&#39;.</span>
<span class="sd">    icd9codes_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing ICD-9 code definitions.</span>
<span class="sd">    icu_history_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing ICU stay descriptions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of pd.DataFrame and dict</span>
<span class="sd">        - diagnoses_df: DataFrame containing descriptions of diagnoses with links to subjects and ICU stays.</span>
<span class="sd">        - definition_map: Dictionary mapping ICD-9 codes to phenotypes and benchmark usage.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_settings</span> <span class="o">=</span> <span class="n">DATASET_SETTINGS</span><span class="p">[</span><span class="s2">&quot;DIAGNOSES_ICD&quot;</span><span class="p">]</span>
    <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s1">&#39;DIAGNOSES_ICD.csv&#39;</span><span class="p">),</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="n">convert_dtype_dict</span><span class="p">(</span><span class="n">csv_settings</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]))</span>
    <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">upper_case_column_names</span><span class="p">(</span><span class="n">diagnoses_df</span><span class="p">)</span>
    <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">icd9codes_df</span><span class="p">,</span>
                                      <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                      <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;ICD9_CODE&#39;</span><span class="p">,</span>
                                      <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;ICD9_CODE&#39;</span><span class="p">)</span>
    <span class="n">diagnoses_df</span> <span class="o">=</span> <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">icu_history_df</span><span class="p">[[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;ICUSTAY_ID&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
                                      <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                      <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">],</span>
                                      <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">])</span>

    <span class="n">diagnoses_df</span><span class="p">[[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;SEQ_NUM&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">diagnoses_df</span><span class="p">[[</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HADM_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;SEQ_NUM&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Clinical Classifications Software CSS defintions of phenotypes</span>
    <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_folder</span><span class="p">,</span> <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;hcup_ccs_2015_definitions.yaml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">phenotypes_yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># Create definition map</span>
    <span class="n">definition_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">phenotype</span> <span class="ow">in</span> <span class="n">phenotypes_yaml</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">phenotypes_yaml</span><span class="p">[</span><span class="n">phenotype</span><span class="p">][</span><span class="s1">&#39;codes&#39;</span><span class="p">]:</span>
            <span class="n">definition_map</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">phenotype</span><span class="p">,</span> <span class="n">phenotypes_yaml</span><span class="p">[</span><span class="n">phenotype</span><span class="p">][</span><span class="s1">&#39;use_in_benchmark&#39;</span><span class="p">])</span>

    <span class="n">diagnoses_df</span><span class="p">[</span><span class="s1">&#39;HCUP_CCS_2015&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">ICD9_CODE</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">definition_map</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                                                 <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">definition_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">diagnoses_df</span><span class="p">[</span><span class="s1">&#39;USE_IN_BENCHMARK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">ICD9_CODE</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">definition_map</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">definition_map</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">diagnoses_df</span><span class="p">,</span> <span class="n">definition_map</span></div>



<div class="viewcode-block" id="make_phenotypes">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.make_phenotypes">[docs]</a>
<span class="k">def</span> <span class="nf">make_phenotypes</span><span class="p">(</span><span class="n">diagnoses_df</span><span class="p">,</span> <span class="n">definition_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a binary matrix with diagnoses over ICU stays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diagnoses_df : pd.DataFrame</span>
<span class="sd">        DataFrame containing diagnoses descriptions with ICU stay information.</span>
<span class="sd">    definition_map : dict</span>
<span class="sd">        Dictionary mapping ICD-9 codes to phenotypes and benchmark usage.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Binary matrix with diagnoses over ICU stays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Merge definitions to diagnoses</span>
    <span class="n">phenotype_dictionary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">definition_map</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;ICD9_CODE&#39;</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;HCUP_CCS_2015&#39;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;USE_IN_BENCHMARK&#39;</span>
    <span class="p">})</span>
    <span class="n">phenotype_dictionary_df</span><span class="p">[</span><span class="s1">&#39;use_in_benchmark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phenotype_dictionary_df</span><span class="p">[</span>
        <span class="s1">&#39;use_in_benchmark&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">phenotypes_df</span> <span class="o">=</span> <span class="n">diagnoses_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">phenotype_dictionary_df</span><span class="p">,</span>
                                       <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
                                       <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;ICD9_CODE&#39;</span><span class="p">,</span>
                                       <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;ICD9_CODE&#39;</span><span class="p">)</span>

    <span class="c1"># Extract phenotypes from diagnoses</span>
    <span class="n">phenotypes_df</span> <span class="o">=</span> <span class="n">phenotypes_df</span><span class="p">[[</span><span class="s1">&#39;ICUSTAY_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;HCUP_CCS_2015&#39;</span>
                                  <span class="p">]][</span><span class="n">phenotypes_df</span><span class="o">.</span><span class="n">use_in_benchmark</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">phenotypes_df</span><span class="p">[</span><span class="s1">&#39;VALUE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Definitions again icu stays</span>
    <span class="n">phenotypes_df</span> <span class="o">=</span> <span class="n">phenotypes_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;icuystay_id&#39;</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;HCUP_CCS_2015&#39;</span><span class="p">,</span>
                                        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;VALUE&#39;</span><span class="p">)</span>

    <span class="c1"># Impute values and sort axes</span>
    <span class="n">phenotypes_df</span> <span class="o">=</span> <span class="n">phenotypes_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">phenotypes_df</span></div>



<div class="viewcode-block" id="get_by_subject">
<a class="viewcode-back" href="../../_rst/datasets.extraction.html#datasets.extraction.get_by_subject">[docs]</a>
<span class="k">def</span> <span class="nf">get_by_subject</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sort_by</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Groups events by subject ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;SUBJECT_ID&#39;</span><span class="p">)}</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># subject_groups(&quot;/home/amadou/Data/ml_data/research-internship/mimic-iii-demo&quot;)</span>
    <span class="n">iterative_extraction</span><span class="p">(</span>
        <span class="n">storage_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/amadou/CodeWorkspace/data/research-internship/processed-trials&quot;</span><span class="p">),</span>
        <span class="n">source_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/amadou/CodeWorkspace/data/mimic-iii-demo&quot;</span><span class="p">),</span>
        <span class="n">ehr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">from_storage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">num_subjects</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amadou Wolfgang Cisse.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>